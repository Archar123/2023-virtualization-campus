# 多核支持

## 任务描述

现代计算机通常具有多个处理核心，这被称为多核架构。每个核心都可以执行独立的计算任务，因此多核处理器可以同时处理多个任务，提高了计算机的性能。多核支持此处指为虚拟机管理软件（如Hypervisor）添加对多核处理器的支持，能够充分利用多核处理器的并行计算能力，以确保虚拟机在多核环境中获得良好的性能。

关于多核支持，首先需要了解在客户机视角的CPU实际上是由Hypervisor虚拟化出的VCpu。通常，一个物理CPU可与一个或多个VCpu绑定。多核支持可以被分解为以下子任务：1. 多核启动。在多核支持的环境中，Hypervisor需要实现多核处理器的启动和初始化。这意味着每个核心都需要被正确地配置和准备，以便可以执行虚拟化操作。这包括启动和配置每个核心上的VCpu，以确保它们能够协同工作，共同支持客户机的运行。 2. 多核同步。多核处理器的核心是并行执行的，因此Hypervisor需要实现多核同步机制。这包括确保各个核心上运行的VCpu之间可以互相通信和同步，以维护虚拟机的稳定性和隔离性。虚拟机的核间通信通常需要触发核间中断来保持一致性,所以hypervisor需要对核间中断进行处理,以保证虚拟核间通信的顺利进行。

## 任务要求

（1）最低要求：完成hypervisor文档的练习。

（2）进阶要求：基于ArceOS，完成其中一个架构（aarch64, x86, riscv）hypervisor支持多核心客户机的运行，要求代码可扩展性强（如果有余力，鼓励完成多个架构的实现）。此处的实现令一个物理CPU只与一个VCpu绑定，即一一对应，其上只需运行单个客户机。例如：4个物理CPU，每个CPU分别对应1个VCpu，共4个VCpu。单个客户机使用这4个VCpu。

（3）挑战要求：基于（1）的实现，令一个物理CPU与多个VCpu绑定，其上仍然只需运行单个客户机。一个物理CPU与多个VCpu绑定会涉及到调度算法以及上下文的切换，可以参考现有常用的调度算法（CFS、FIFO、RR）进行实现，或对其进行改进。例如：2个物理CPU，每个CPU分别对应2个VCpu，共4个VCpu。单个客户机使用这4个VCpu。

## 任务考核

（1）现场演示：运行多核客户机，并在其中运行利用多核执行的程序，打印出相关信息。

（2）测试：首先为每个实现的功能提供合适的测试样例，其次进行性能测试，评估Hypervisor在多核环境中的性能和资源利用率。

（3）详细的代码文档。


