# 设备和中断虚拟化

## 任务描述：

向虚拟机提供各种不同的虚拟设备是Hypervisor的重要工作。从I/O类型上分，虚拟设备可以分为端口映射 I/O（PMIO） 设备、内存映射I/O（MMIO）设备、DMA设备等；从虚拟机访问设备的方式上分，可以分为直通设备、模拟设备和半虚拟化设备等。

PMIO是一种较古老的I/O方式，每个设备有一个或多个端口号，CPU通过专用的I/O指令读写数据；由于其CPU占用率高等缺点，许多新的架构已经不支持此种I/O方式。MMIO是相对较为主流的I/O方式，设备接入总线，并在地址空间中有一段地址，CPU使用访存指令访问此段地址即可完成和设备的数据交互。DMA更进一步允许设备直接读写主存。

“直通”指将某个物理设备分配给某台虚拟机独占使用，其他虚拟机和Hypervisor都不能访问；这种方式性能最好，实现简单，但是设备利用率可能不高，也无法给虚拟机提供不存在的设备。“模拟”指Hypervisor向虚拟机提供物理上不存在的设备，拦截虚拟机对该设备的所有访问操作，并且用代码模拟设备的功能；这种方式最为灵活，但实现复杂，性能不高。半虚拟化指虚拟机内的系统和Hypervisor按照约定好的接口进行通信，而不需要遵循真实设备的访问方式；这种方式性能相比于纯粹模拟更好，但需要虚拟机内的系统知道自己处于虚拟机中并安装相应的驱动程序；常见的半虚拟化规范有virtio等。

在大部分情况下，访问设备离不开中断机制。中断是设备主动通知CPU的重要途径。

## 任务要求：

1.【基础】理解和实现x86下PMIO虚拟化

a.阅读理解现有的PMIO虚拟方案；

b.补全现有的虚拟16550UART实现，或者添加一个新的虚拟PMIO设备；

2.【基础，和3二选一】MMIO虚拟化

a.了解mmio相关的知识；

b.选取一个MMIO设备（如PCIE设备等）并实现；

3.【基础，和2二选一】virtio虚拟化

a.了解virtio相关的知识；

b.实现一个virtio网络设备和一个virtio磁盘设备。

## 任务考核
